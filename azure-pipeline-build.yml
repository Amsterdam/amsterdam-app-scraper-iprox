pool:
  vmImage: ubuntu-latest

variables:
- group: container-registry
- name: imageName
  value: scraper-iprox
- name: tag
  value: $(imageName):$(Build.BuildNumber)
- name: unittestPassed
  value: false
- name: testBool
  value: false

steps:
- script: |   
    echo 'Building docker container with tag: $(tag)'
    docker build -f $(Build.SourcesDirectory)/build-docker-image/Dockerfile -t $(tag) .
  displayName: 'Build docker image'

- bash: |
    echo "testBool: $(testBool)"
    echo "##vso[task.setvariable variable=testBool;]true"
    echo "testBool: $(testBool)"
  displayName: 'Test set variable'

- bash: |
    echo "testBool expanded: $(testBool)"
  displayName: 'Test expanded variable'

- script: | 
    echo "unittestPassed: $(unittestPassed)"
    docker run -e UNITTEST=true $(tag) && "##vso[task.setvariable variable=unittestPassed;]true"
    
    echo "unittestPassed: $(unittestPassed)"
    
    # if [ $(unittestPassed) == 'false' ]; then
    #   exit 1
    # fi
  displayName: 'Run unittests'

- script: |    
    echo "unittestPassed: $(unittestPassed)"
    if [ $(unittestPassed) == 'false' ]; then
      exit 1
    fi    
  displayName: 'Fail if unittest result is false'